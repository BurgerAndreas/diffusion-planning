# Diffusion planning in the Maze2D domain

## FAQ

What is Multi2D?
- Modification of the original Maze2D, with randomized goal location at the beginning of each episode ('multi-task')

Is Maze2D discrete or continuous?
- Even though it looks discrete, it is continuous. The agent can move in any direction, but the environment is designed to look like a grid.

Are we rendering the diffuser output or is the rendering the input to the diffuser?
- The rendering is just for visualization. The input and output to the diffuser is (batch_size, planning_horizon, state_dim + action_dim)

How are the start and endpoints given to the diffuser?
- inpainting strategy to condition on a start and goal location
- generalize by simply change the conditioning goal 
- condition the trajectories on the current state using the inpainting procedure
- no conditioning in the sense of classifier / classifier-free guidance?

How do we ensure the walls are not crossed?
- We don't enforce that collision constraint explicitly; the samples respect this by virtue of there being no data that walks through the walls [see github issue](https://github.com/jannerm/diffuser/issues/6)

What data is the diffuser trained on?
- training data in Maze2D is undirected – consisting of a controller navigating to and from randomly selected locations
- You can see the training data in `logs/<task>/diffusion/<>/_sample-reference.png` 
(generated by `diffuser-maze2d/diffuser/utils/training.py Trainer.render_reference`)


planning horizon T of 128 in Maze2D / Multi2D U-Maze, 265 in Maze2D / Multi2D Medium, and 384 in Maze2D / Multi2D Large

guide scale of α = 0.1

How long does the diffusion model take to train? 
- A separate model is trained for each maze size. On one RTX3060, with default parameters:
- maze2d-large-v1: 20h (200 epochs, ~1000 training trajectories per epoch)
- maze2d_umaze_v1:
- maze2d_medium_v1:

## Our approach

- Keep the diffusion model (e.g. trained on maze2d-large-v1) as is, without any additional training
- Construct a larger maze by concatenating multiple smaller mazes
- Discretize the larger maze into a grid for the planner
- Get the planner to output a trajectory in the larger maze
- Sample waypoints on the planner trajectory and use them as start and goal locations for the diffuser
- Diffuser only acts on mazes the size it was trained on 

- size of maze2d-large-v1 = (S x S)
- concatenate L^2 mazes to get a maze of size (L*S x L*S)
